---
// src/pages/login.astro
// If you have a Layout component, swap the shell below:
// import Layout from '../layouts/Layout.astro';

const authApiUrl  = import.meta.env.PUBLIC_AUTH_API_URL  ?? 'https://auth.insighthunter.io';
const liteAppUrl  = import.meta.env.PUBLIC_LITE_APP_URL  ?? 'https://lite.insighthunter.io';

// Redirect already-authenticated users away from the login page
// (only works in SSR mode; remove if you're using static output)
// const token = Astro.cookies.get('auth_token');
// if (token) return Astro.redirect('/dashboard');
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login – InsightHunter</title>
  <link rel="stylesheet" href="/styles.css" />
  <link
    href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap"
    rel="stylesheet"
  />
</head>
<body class="page">

  <div class="topbar">
    <div class="brand">INSIGHTHUNTER</div>
    <nav class="nav">
      <a href="/">Home</a>
      <a href="/features">Features</a>
      <a href="/pricing">Pricing</a>
      <a href="/about">About</a>
      <a href="/my-account">My Account</a>
      <a href="/login" class="active">Login</a>
      <a href="/signup" class="btn-primary">Sign Up</a>
    </nav>
  </div>

  <main class="main">
    <section class="card form-container">
      <h1>Login to your account</h1>

      <form id="login-form" class="form" novalidate>
        <label for="email">Email</label>
        <input type="email" id="email" name="email" autocomplete="email" required />

        <label for="password">Password</label>
        <input
          type="password"
          id="password"
          name="password"
          autocomplete="current-password"
          required
        />

        <p id="error-message" role="alert" aria-live="polite" style="color: red; min-height: 1.25rem;"></p>

        <button type="submit" id="submit-btn" class="btn-primary">Login</button>
      </form>

      <p>Don't have an account? <a href="/signup">Sign up</a></p>
      <p><a href="/forgot-password">Forgot your password?</a></p>
    </section>
  </main>

  <footer class="footer">
    <p>&copy; {new Date().getFullYear()} InsightHunter. All rights reserved.</p>
    <a href="/legal/privacy">Privacy Policy</a>
    <a href="/legal/terms">Terms of Service</a>
  </footer>

  <!-- Astro processes this as TypeScript automatically -->
  <script define:vars={{ authApiUrl, liteAppUrl }}>
    interface LoginResponse {
      success: boolean;
      token?: string;
      error?: string;
    }

    const loginForm    = document.getElementById('login-form')    as HTMLFormElement;
    const errorMessage = document.getElementById('error-message') as HTMLParagraphElement;
    const submitBtn    = document.getElementById('submit-btn')    as HTMLButtonElement;

    loginForm.addEventListener('submit', async (event: Event) => {
      event.preventDefault();
      errorMessage.textContent = '';
      submitBtn.disabled = true;
      submitBtn.textContent = 'Logging in…';

      const email    = (loginForm.elements.namedItem('email')    as HTMLInputElement).value;
      const password = (loginForm.elements.namedItem('password') as HTMLInputElement).value;

      try {
        const response = await fetch(`${authApiUrl}/api/login`, {
          method:  'POST',
          headers: { 'Content-Type': 'application/json' },
          body:    JSON.stringify({ email, password }),
        });

        // Treat non-2xx as an error before parsing JSON
        if (!response.ok && response.status !== 401) {
          throw new Error(`Server error: ${response.status}`);
        }

        const  LoginResponse = await response.json();

        if (data.success && data.token) {
          // Store token safely — never put it in the URL
          sessionStorage.setItem('auth_token', data.token);
          window.location.href = `${liteAppUrl}/dashboard`;
        } else {
          errorMessage.textContent = data.error ?? 'Invalid email or password.';
        }
      } catch (error) {
        console.error('Login failed:', error);
        errorMessage.textContent =
          error instanceof Error && error.message.startsWith('Server error')
            ? 'The server is temporarily unavailable. Please try again.'
            : 'Could not connect to the authentication service.';
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Login';
      }
    });
  </script>

</body>
</html>
