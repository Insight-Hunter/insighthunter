---
// src/pages/clients.astro
import AppLayout from '../layouts/AppLayout.astro';
---

<AppLayout title="Clients">
  <div class="clients-page">
    <div class="header">
      <h1>Clients</h1>
      <button id="addClientBtn" class="btn-primary">+ Add Client</button>
    </div>

    <div id="clientsList" class="clients-grid"></div>

    <dialog id="clientDialog">
      <form id="clientForm">
        <h2>Add New Client</h2>
        <input type="text" name="name" placeholder="Client Name" required />
        <input type="email" name="email" placeholder="Email" required />
        <input type="tel" name="phone" placeholder="Phone" />
        <textarea name="address" placeholder="Address" rows="3"></textarea>
        <input type="text" name="taxId" placeholder="Tax ID / EIN" />
        <div class="dialog-actions">
          <button type="button" id="cancelBtn" class="btn-secondary">Cancel</button>
          <button type="submit" class="btn-primary">Save Client</button>
        </div>
      </form>
    </dialog>
  </div>
</AppLayout>

<style>
  .clients-page {
    padding: 2rem;
  }

  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
  }

  .clients-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
  }

  .client-card {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .client-card h3 {
    margin-bottom: 0.5rem;
  }

  .client-card p {
    color: #666;
    margin: 0.25rem 0;
  }

  dialog {
    border: none;
    border-radius: 12px;
    padding: 2rem;
    max-width: 500px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
  }

  dialog::backdrop {
    background: rgba(0, 0, 0, 0.5);
  }

  dialog form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  dialog input,
  dialog textarea {
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 1rem;
  }

  .dialog-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    margin-top: 1rem;
  }

  .btn-primary,
  .btn-secondary {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 6px;
    font-size: 1rem;
    cursor: pointer;
  }

  .btn-primary {
    background: #667eea;
    color: white;
  }

  .btn-secondary {
    background: #e0e0e0;
    color: #333;
  }
</style>

<script>
  const API_URL = 'http://localhost:8787';
  const companyId = 'default';

  const dialog = document.getElementById('clientDialog') as HTMLDialogElement;
  const form = document.getElementById('clientForm') as HTMLFormElement;
  const clientsList = document.getElementById('clientsList')!;

  document.getElementById('addClientBtn')!.addEventListener('click', () => {
    dialog.showModal();
  });

  document.getElementById('cancelBtn')!.addEventListener('click', () => {
    dialog.close();
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    const client = Object.fromEntries(formData);

    try {
      await fetch(`${API_URL}/api/clients/${companyId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(client),
      });

      dialog.close();
      form.reset();
      loadClients();
    } catch (error) {
      console.error('Failed to create client:', error);
    }
  });

  async function loadClients() {
    try {
      const response = await fetch(`${API_URL}/api/clients/${companyId}`);
      const data = await response.json();

      clientsList.innerHTML = data.clients
        .map(
          (client: any) => `
        <div class="client-card">
          <h3>${client.name}</h3>
          <p>üìß ${client.email}</p>
          ${client.phone ? `<p>üìû ${client.phone}</p>` : ''}
          ${client.address ? `<p>üìç ${client.address}</p>` : ''}
          ${client.taxId ? `<p>üÜî ${client.taxId}</p>` : ''}
        </div>
      `
        )
        .join('');
    } catch (error) {
      console.error('Failed to load clients:', error);
    }
  }

  loadClients();
</script>
